package tlv

import (
	"bytes"
	"testing"

	"github.com/gmrtd/gmrtd/utils"
)

func TestParseTagAndLength(t *testing.T) {
	testCases := []struct {
		inpBytes  []byte
		expErr    bool
		expTag    TlvTag
		expLength TlvLength
	}{
		{
			// ok
			inpBytes:  utils.HexToBytes("0102"),
			expErr:    false,
			expTag:    1,
			expLength: 2,
		},
		{
			// ok
			inpBytes:  utils.HexToBytes("028105"),
			expErr:    false,
			expTag:    2,
			expLength: 5,
		},
		{
			// ok
			inpBytes:  utils.HexToBytes("03820502"),
			expErr:    false,
			expTag:    3,
			expLength: 0x0502,
		},
		{
			// error: bad TLV
			inpBytes: utils.HexToBytes("01"),
			expErr:   true,
		},
		{
			// error: bad TLV
			inpBytes: utils.HexToBytes("018210"),
			expErr:   true,
		},
		{
			// error: bad TLV (incomplete multi-byte tag.. e.g. 5F42->5F)
			inpBytes: utils.HexToBytes("5F"),
			expErr:   true,
		},
	}
	for _, tc := range testCases {
		buf := bytes.NewBuffer(tc.inpBytes)

		tag, length, err := ParseTagAndLength(buf)

		if tc.expErr {
			/*
			* error EXPECTED
			 */

			if err == nil {
				t.Errorf("error expected")
			}
		} else {
			/*
			* error NOT expected
			 */

			if err != nil {
				t.Errorf("Unexpected error: %s", err)
			}

			if tag != tc.expTag {
				t.Errorf("Tag differs to expected (Exp:%x, Act:%x)", tc.expTag, tag)
			}

			if length != tc.expLength {
				t.Errorf("Length differs to expected (Exp:%x, Act:%x)", tc.expLength, length)
			}
		}
	}
}

func TestUnwrapTag(t *testing.T) {
	testCases := []struct {
		inpTag   TlvTag
		inpBytes []byte
		expErr   bool
		expValue []byte
	}{
		{
			// valid
			inpTag:   1,
			inpBytes: utils.HexToBytes("01021234"),
			expErr:   false,
			expValue: utils.HexToBytes("1234"),
		},
		{
			// invalid - valid TLV, but tag mismatch
			inpTag:   2,
			inpBytes: utils.HexToBytes("01021234"),
			expErr:   true,
		},
		{
			// invalid - less data than expected (value has 9 bytes but 10 bytes expected)
			inpTag:   2,
			inpBytes: utils.HexToBytes("020A123456789012345678"),
			expErr:   true,
		},
		{
			// invalid - extra data present (xFF)
			inpTag:   2,
			inpBytes: utils.HexToBytes("020A12345678901234567890FF"),
			expErr:   true,
		},
		{
			// invalid - bad TLV, missing length/value
			inpTag:   2,
			inpBytes: utils.HexToBytes("02"),
			expErr:   true,
		},
	}
	for _, tc := range testCases {
		actValue, err := UnwrapTag(tc.inpTag, tc.inpBytes)

		if tc.expErr {
			if err == nil {
				t.Errorf("Error expected")
			}

			if len(actValue) > 0 {
				t.Errorf("Value not expected for error case")
			}
		} else {
			if err != nil {
				t.Errorf("Unexpected error: %s", err)
			} else if !bytes.Equal(tc.expValue, actValue) {
				t.Errorf("Value differs to expected (act:%x, exp:%x)", actValue, tc.expValue)
			}
		}
	}
}

func TestDecodeEncode(t *testing.T) {
	testCases := []struct {
		inpBytes []byte
		expErr   bool
		expBytes []byte
	}{
		{
			// error: missing value
			inpBytes: utils.HexToBytes("010A"),
			expErr:   true,
		},
		{
			// valid
			inpBytes: utils.HexToBytes("01021234"),
			expErr:   false,
			expBytes: utils.HexToBytes("01021234"),
		},
		{
			// valid - but should be modified to remove 'indefinite' length encoding
			// - sample data taken from real NZ SOD
			inpBytes: utils.HexToBytes("77820852308006092A864886F70D010702A0803080020103310F300D0609608648016503040201050030800606678108010101A080048201003081FD020100300B06096086480165030402013081EA30250201010420C34B96088C91A4B07DEEC841D55A886B51E1C7AFD79F058F42171FA498F95F2430250201020420C2BFB7E9B14CE960FE1AC3B455913624D1E1ED4AB92E6E2D20A69EC986116787302502010C0420022FFD5A0A871EC28947EC940FB279FDBCB4B25EF03465E653BCD3DD5C370A5F302502010D0420FDD73AEF84C4F9FC4AB807F2EFADBD013452F1EE7200287ADDED53EDCC5D2BB7302502010E04203C8134CF5A985863519B68BD8FA5EE2EDCAD7C375247393E02D84C0DBD7939D3302502010F0420A5ED6C2A093E548A30F0BEF91AC4C07D12E5733DF252AF1E24FCED0ECE56BF9900000000A0820503308204FF308202E7A003020102020442E57A41300D06092A864886F70D01010B0500306D310B3009060355040613024E5A31223020060355040A0C19476F7665726E6D656E74206F66204E6577205A65616C616E6431123010060355040B0C0950617373706F72747331263024060355040B0C1D4964656E746974792053657276696365732050617373706F7274204341301E170D3137313030313230333935365A170D3238303231323131303030305A307B310B3009060355040613024E5A31223020060355040A0C19476F7665726E6D656E74206F66204E6577205A65616C616E6431123010060355040B0C0950617373706F727473310D300B060355040B0C044D5254443125302306035504030C1C446F63756D656E74205369676E65722032303137313030323030303130820122300D06092A864886F70D01010105000382010F003082010A0282010100C0287BDE6240E37AEC9741D64947758B2BBBCD58A87429442FA6C14EE6481F94D2A221352E663D4C1EAEC896F18C235160D47B548E5B445948C976614D263C6568EA9D08EA504FD930D9775D9CE82A3A834C4EFDE2D6BAB04C499045A3C25DCF29C8E9BA4C58958300C687323066A2AD9EA54C8A23D4AA75DBCAF0AE5CFC8176A94B891AD97C328CA03186C1151D4EB3DCBBCABEF8A9F77F50959BFE30891605A7725BF6DE59240DD1818C6CBD4B71C9A41C8D0A8C77ECA1559B3CA124A09F75BB44178A17E29D5C871DA0DC5A50DAD2873321FDEFE8374ABFE41FB0FC2CC2CB4F255AA5FB3D614B18FEE3FE3346C8E0F9F73DE66348E011A17BE8851C59D3250203010001A38198308195300E0603551D0F0101FF040403020780302B0603551D1004243022800F32303137313030313230333935365A810F32303138303231323131303030305A30160603551D20040F300D300B060960842A65826C010101301F0603551D23041830168014F9D6C969FE97D184EEF2C1D7E520B66032BE3DF7301D0603551D0E0416041424757F42B10EE096409789FFAD2D9150ECFDC5BE300D06092A864886F70D01010B050003820201000D64025FB39BBB1606C76AE6211DD773B0B02675D079EBC3283A8E84C763024471463272B2DC389DB2CB282A0931BC57627B9F4FE774BA031C97F371FA9A50FDB0F363FE85786DDACC3E3264317312BC538116D1664A84B641E8260F23DD6B8D5EB42399B2EA944EE20DAFAA074CAFC9F93FEBAEA4D17C8A2DE3200A335BA3260D594A85D85DB9C5D2391FB9190F4BF30835D1E9965EB22FB35D7E8380A7BD014F9757E4D4934F548D47E35B878FC2C7DC411C01EA54EB33CB0B91EC88D91B67B45C30B021F6D9A866000A80686047C8365B1B81099FCAB5AF3642993498BC8B667812872319ED6395C39D4183C21BC1CD7BFE5381479775AFFA8CE9B2DE8347C4623382320BBE4466D700941175A0802AE0182EC882FF26C5351B754270C3129895A58E659690774C5C175B9903A33FB111D10F856F6D452F3D58A9BCBB414CF3017F803E718470007120C65255AEFFF526A15297B5191A1EBCCEB63680039C5B04D08EA739DF0628EA109B42F87411553FBA2BB4A23F64E012F0C7DFAFB5ED7AFE7DC474F87A741E01A03A09AF84F5E7F5CA15A0114C377F6B0012DF83F9E694E839D190658945BF7014FA69E5CC6AE75C96DD3AB98CE636D9EF42A80D5A24EC3D83C6E1195E2EFCD63B335DBD32717F71858D50998C383291D530F1BF8D5C7ECF674A1F200F989D2589FB6A634666EEB9E33441ABDB060DDF0576420F4D0A31820208308202040201013075306D310B3009060355040613024E5A31223020060355040A0C19476F7665726E6D656E74206F66204E6577205A65616C616E6431123010060355040B0C0950617373706F72747331263024060355040B0C1D4964656E746974792053657276696365732050617373706F7274204341020442E57A41300D06096086480165030402010500A066301506092A864886F70D01090331080606678108010101301C06092A864886F70D010905310F170D3137313131353030333631325A302F06092A864886F70D0109043122042071CB0413DAC76278E04BF30A3DF13AFC0D706E3C95CCE1D16250B6AE3694EEFD300D06092A864886F70D0101010500048201003593195E884103297DFE628DC10230063BCEF6EDF13369499ECE259AE1F70C1A59CCE9F1B444B2F9D12C7C2C877D7BE1B81B61A36827862A596853412D1849CA36E6E5DE095C7A8D505784955AD321CBCCBE7A6F5172BC26E32C9F01C8C5D7CF38CF33AA53A4E174CBC86D5E18A9312A2D5377027A274D002A5AB4F5FEDFB3CC5AF9EB4B7D6158A8BEF16A627BE88058342683699E72B3E2F35F5A7E41451D458AE92A6D26DA693DF4BD4D9D8A498A07323934FB50C9B9BCCA013E98E872937AE3875FBA6665E3B92CF22F33A1087C5CB655724A1FFF183F4BE5980E3BC19A46F9656EF81AD2ED6EE3F0E74DC91EC71C1A82FC1DB4E1ED8DD5EEF9A6361CB849000000000000"),
			expErr:   false,
			expBytes: utils.HexToBytes("778208523082084e06092a864886f70d010702a082083f3082083b020103310f300d06096086480165030402010500308201100606678108010101a0820104048201003081fd020100300b06096086480165030402013081ea30250201010420c34b96088c91a4b07deec841d55a886b51e1c7afd79f058f42171fa498f95f2430250201020420c2bfb7e9b14ce960fe1ac3b455913624d1e1ed4ab92e6e2d20a69ec986116787302502010c0420022ffd5a0a871ec28947ec940fb279fdbcb4b25ef03465e653bcd3dd5c370a5f302502010d0420fdd73aef84c4f9fc4ab807f2efadbd013452f1ee7200287added53edcc5d2bb7302502010e04203c8134cf5a985863519b68bd8fa5ee2edcad7c375247393e02d84c0dbd7939d3302502010f0420a5ed6c2a093e548a30f0bef91ac4c07d12e5733df252af1e24fced0ece56bf99a0820503308204ff308202e7a003020102020442e57a41300d06092a864886f70d01010b0500306d310b3009060355040613024e5a31223020060355040a0c19476f7665726e6d656e74206f66204e6577205a65616c616e6431123010060355040b0c0950617373706f72747331263024060355040b0c1d4964656e746974792053657276696365732050617373706f7274204341301e170d3137313030313230333935365a170d3238303231323131303030305a307b310b3009060355040613024e5a31223020060355040a0c19476f7665726e6d656e74206f66204e6577205a65616c616e6431123010060355040b0c0950617373706f727473310d300b060355040b0c044d5254443125302306035504030c1c446f63756d656e74205369676e65722032303137313030323030303130820122300d06092a864886f70d01010105000382010f003082010a0282010100c0287bde6240e37aec9741d64947758b2bbbcd58a87429442fa6c14ee6481f94d2a221352e663d4c1eaec896f18c235160d47b548e5b445948c976614d263c6568ea9d08ea504fd930d9775d9ce82a3a834c4efde2d6bab04c499045a3c25dcf29c8e9ba4c58958300c687323066a2ad9ea54c8a23d4aa75dbcaf0ae5cfc8176a94b891ad97c328ca03186c1151d4eb3dcbbcabef8a9f77f50959bfe30891605a7725bf6de59240dd1818c6cbd4b71c9a41c8d0a8c77eca1559b3ca124a09f75bb44178a17e29d5c871da0dc5a50dad2873321fdefe8374abfe41fb0fc2cc2cb4f255aa5fb3d614b18fee3fe3346c8e0f9f73de66348e011a17be8851c59d3250203010001a38198308195300e0603551d0f0101ff040403020780302b0603551d1004243022800f32303137313030313230333935365a810f32303138303231323131303030305a30160603551d20040f300d300b060960842a65826c010101301f0603551d23041830168014f9d6c969fe97d184eef2c1d7e520b66032be3df7301d0603551d0e0416041424757f42b10ee096409789ffad2d9150ecfdc5be300d06092a864886f70d01010b050003820201000d64025fb39bbb1606c76ae6211dd773b0b02675d079ebc3283a8e84c763024471463272b2dc389db2cb282a0931bc57627b9f4fe774ba031c97f371fa9a50fdb0f363fe85786ddacc3e3264317312bc538116d1664a84b641e8260f23dd6b8d5eb42399b2ea944ee20dafaa074cafc9f93febaea4d17c8a2de3200a335ba3260d594a85d85db9c5d2391fb9190f4bf30835d1e9965eb22fb35d7e8380a7bd014f9757e4d4934f548d47e35b878fc2c7dc411c01ea54eb33cb0b91ec88d91b67b45c30b021f6d9a866000a80686047c8365b1b81099fcab5af3642993498bc8b667812872319ed6395c39d4183c21bc1cd7bfe5381479775affa8ce9b2de8347c4623382320bbe4466d700941175a0802ae0182ec882ff26c5351b754270c3129895a58e659690774c5c175b9903a33fb111d10f856f6d452f3d58a9bcbb414cf3017f803e718470007120c65255aefff526a15297b5191a1ebcceb63680039c5b04d08ea739df0628ea109b42f87411553fba2bb4a23f64e012f0c7dfafb5ed7afe7dc474f87a741e01a03a09af84f5e7f5ca15a0114c377f6b0012df83f9e694e839d190658945bf7014fa69e5cc6ae75c96dd3ab98ce636d9ef42a80d5a24ec3d83c6e1195e2efcd63b335dbd32717f71858d50998c383291d530f1bf8d5c7ecf674a1f200f989d2589fb6a634666eeb9e33441abdb060ddf0576420f4d0a31820208308202040201013075306d310b3009060355040613024e5a31223020060355040a0c19476f7665726e6d656e74206f66204e6577205a65616c616e6431123010060355040b0c0950617373706f72747331263024060355040b0c1d4964656e746974792053657276696365732050617373706f7274204341020442e57a41300d06096086480165030402010500a066301506092a864886f70d01090331080606678108010101301c06092a864886f70d010905310f170d3137313131353030333631325a302f06092a864886f70d0109043122042071cb0413dac76278e04bf30a3df13afc0d706e3c95cce1d16250b6ae3694eefd300d06092a864886f70d0101010500048201003593195e884103297dfe628dc10230063bcef6edf13369499ece259ae1f70c1a59cce9f1b444b2f9d12c7c2c877d7be1b81b61a36827862a596853412d1849ca36e6e5de095c7a8d505784955ad321cbccbe7a6f5172bc26e32c9f01c8c5d7cf38cf33aa53a4e174cbc86d5e18a9312a2d5377027a274d002a5ab4f5fedfb3cc5af9eb4b7d6158a8bef16a627be88058342683699e72b3e2f35f5a7e41451d458ae92a6d26da693df4bd4d9d8a498a07323934fb50c9b9bcca013e98e872937ae3875fba6665e3b92cf22f33a1087c5cb655724a1fff183f4be5980e3bc19a46f9656ef81ad2ed6ee3f0e74dc91ec71c1a82fc1db4e1ed8dd5eef9a6361cb849"),
		},
	}
	for _, tc := range testCases {
		actBytes, err := DecodeEncode(tc.inpBytes)

		if tc.expErr {
			if err == nil {
				t.Errorf("Error expected")
			}

			if len(actBytes) > 0 {
				t.Errorf("Data not expected for error case")
			}
		} else {
			if err != nil {
				t.Errorf("Unexpected error: %s", err)
			} else if !bytes.Equal(tc.expBytes, actBytes) {
				t.Errorf("Bytes differ to expected (act:%x, exp:%x)", actBytes, tc.expBytes)
			}
		}
	}
}
